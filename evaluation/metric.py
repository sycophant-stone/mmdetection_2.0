import numpy as np

def iou(boxA, boxB):
    '''
    get iou
    :param boxA:
    :param boxB:
    :return:
    '''
    xx1 = max(boxA[0], boxB[0])
    yy1 = max(boxA[1], boxB[1])
    xx2 = min(boxA[2], boxB[2])
    yy2 = min(boxA[3], boxB[3])

    w = max(0, xx2-xx1+1)
    h = max(0, yy2-yy1+1)

    inter_area = w*h
    areaA = (boxA[2] - boxA[0] + 1) * (boxA[3] - boxA[1] + 1)
    areaB = (boxB[2] - boxB[0] + 1) * (boxB[3] - boxB[1] + 1)
    return float(inter_area) / (areaA + areaB - inter_area)

def vector_iou(bboxesA, bboxesB):
    '''
    calc iou in vectorized
    :param bboxesA:
    :param bboxesB:
    :return:
    '''

    xx1 = np.maximum(bboxesA[:, 0], bboxesB[:, 0])
    yy1 = np.maximum(bboxesA[:, 1], bboxesB[:, 1])
    xx2 = np.minimum(bboxesA[:, 2], bboxesB[:, 2])
    yy2 = np.minimum(bboxesA[:, 3], bboxesB[:, 3])

    w = np.maximum(0, xx2-xx1+1)
    h = np.maximum(0, yy2-yy1+1)
    inter_area = w*h
    areaA = (bboxesA[:, 2] - bboxesA[:, 0] + 1) * (bboxesA[:, 3] - bboxesA[:, 1] + 1)
    areaB = (bboxesB[:, 2] - bboxesB[:, 0] + 1) * (bboxesB[:, 3] - bboxesB[:, 1] + 1)

    # print("inter_area:", inter_area)
    # print("areaA: ", areaA)
    # print("areaB: ", areaB)
    return inter_area/(areaA+areaB-inter_area) # the inter_area is already float.

def Test_vector_iou():
    '''
    test vector_iou with numpy arraies.
    :return:
    '''
    np_gt_bboxes = np.array([[ 86, 65, 213, 192, 0]])
    np_pred_bboxes = np.array([[155.2559967 ,56.17427444 ,234.23742676 ,130.85536194 ,0.08804351],
                               [145.27090454 ,32.4577179 ,221.90159607 ,102.23336792 ,0.02735894],
                               [210.57479858 ,46.67746735 ,293.90423584 ,124.65774536 ,0.1252396],
                               [0,82.13592529 ,59.31777191 ,160.58796692 ,0.07966981],
                               [0.44424725 ,193.2129364 ,41.30558777 ,292.58874512 ,0.05482619],
                               [239.84074402 ,32.41260529 ,300,111.71971893 ,0.13480234],
                               [144.1459198 ,82.81218719 ,228.98207092 ,167.79101562 ,0.05315798],
                               [48.80640411 ,26.42819214 ,135.63269043 ,119.50806427 ,0.04002618],
                               [64.49249268 ,154.47532654 ,190.02038574 ,282.30548096 ,0.04607767],
                               [266.34786987 ,252.34465027 ,300,300,0.00145165],
                               [21.89854813 ,30.49913788 ,102.75657654 ,113.90991211 ,0.03187124],
                               [0.81583977 ,244.25921631 ,43.96905899 ,295.24099731 ,0.02831967],
                               [0,102.72910309 ,63.05898666 ,272.440979 ,0.03795101],
                               [196.69578552 ,64.54896545 ,281.54229736 ,151.3407135 ,0.03129751],
                               [52.99843597 ,63.70558548 ,136.17256165 ,145.35832214 ,0.02287948],
                               [15.15391541 ,1.35276222 ,287.40390015 ,300,0.01428788],
                               [93.74280548 ,151.32754517 ,246.33503723 ,300,0.01062296],
                               [33.95590973 ,76.61747742 ,143.23519897 ,179.68305969 ,0.0604181 ],
                               [151.78041077 ,118.9949646 ,226.14094543 ,197.80963135 ,0.02016598],
                               [149.54769897 ,23.41348076 ,300,209.22201538 ,0.00486512],
                               [0.04657745 ,70.76318359 ,93.33683777 ,199.65499878 ,0.0207339 ],
                               [1.95971298 ,56.5698204 ,72.46530151 ,139.16223145 ,0.11171891],
                               [136.9306488 ,6.483181 ,244.79699707 ,106.65258789 ,0.02213242],
                               [239.5745697 ,67.70735168 ,300,136.97706604 ,0.0324645 ],
                               [88.67347717 ,52.51515198 ,187.48118591 ,157.92726135 ,0.23243237],
                               [82.02029419 ,32.74715424 ,166.32099915 ,118.57878113 ,0.03499374],
                               [85.64297485 ,240.05773926 ,212.48623657 ,299.31289673 ,0.02620881],
                               [40.55447769 ,0,113.92544556 ,41.29604721 ,0.01209538],
                               [105.98748779 ,119.1373291 ,189.05447388 ,190.36946106 ,0.02185913],
                               [24.65156174 ,239.02731323 ,119.30151367 ,296.8614502 ,0.02780067],
                               [3.30274391 ,105.0544281 ,42.13493347 ,173.71963501 ,0.03629385],
                               [34.49074554 ,153.80499268 ,127.2102356 ,249.52766418 ,0.03473684],
                               [52.9494133 ,135.5178833 ,138.89945984 ,224.73658752 ,0.03718649],
                               [45.68843842 ,180.6723938 ,136.70193481 ,269.82128906 ,0.04842368],
                               [2.36795044 ,117.70222473 ,57.15232849 ,192.62374878 ,0.03311637],
                               [105.10531616 ,3.02963448 ,194.10223389 ,97.78271484 ,0.01664256],
                               [132.83978271 ,137.31365967 ,206.76953125 ,196.52427673 ,0.03647193],
                               [48.44279861 ,0,232.68411255 ,124.40924072 ,0.00874143],
                               [117.1822052 ,97.13327026 ,217.16362 ,192.7492981 ,0.15377855],
                               [12.06048584 ,75.35276794 ,91.37213135 ,149.4356842 ,0.04288729],
                               [102.35876465 ,160.23423767 ,192.62997437 ,243.45477295 ,0.02927846],
                               [0,161.82548523 ,47.51126862 ,246.52127075 ,0.05163179],
                               [98.0082016 ,139.92617798 ,178.03895569 ,207.1764679 ,0.01502619],
                               [76.93616486 ,60.88222122 ,212.31866455 ,197.50222778 ,0.60609734],
                               [74.04951477 ,115.02674103 ,191.60900879 ,234.04824829 ,0.05298604],
                               [5.86647415 ,0,152.02165222 ,112.14483643 ,0.00718487],
                               [54.86859512 ,0,127.09472656 ,62.46998978 ,0.02513843],
                               [42.53842926 ,84.84142303 ,114.99690247 ,155.39588928 ,0.03537332],
                               [246.75219727 ,13.21623611 ,299.46224976 ,83.04528046 ,0.07251477],
                               [85.74679565 ,0,163.02069092 ,85.08773041 ,0.01910223],
                               [59.41116714 ,105.59539795 ,138.86691284 ,187.55696106 ,0.03351925],
                               [4.29908752 ,35.22028351 ,69.42123413 ,110.69744873 ,0.17724094],
                               [76.50315094 ,125.65431213 ,154.0769043 ,196.37445068 ,0.01771734],
                               [160.75402832 ,36.87992096 ,260.94464111 ,143.91967773 ,0.18589336],
                               [131.75868225 ,0,227.6002655 ,66.78517151 ,0.01127093],
                               [68.88357544 ,206.68414307 ,198.50917053 ,294.98373413 ,0.0254651 ],
                               [14.75165176 ,183.24002075 ,104.47222137 ,286.76049805 ,0.02775957],
                               [5.42164612 ,138.3578186 ,139.48448181 ,292.39733887 ,0.03860704],
                               [98.64402771 ,90.03167725 ,178.89508057 ,173.47209167 ,0.0874007 ],
                               [22.35657883 ,96.89321899 ,100.67817688 ,173.71702576 ,0.04377215],
                               [113.23023987 ,55.31213379 ,192.11680603 ,127.43144226 ,0.15743679],
                               [43.22002411 ,18.707901 ,116.90085602 ,91.37536621 ,0.0366148 ],
                               [80.22755432 ,75.44726562 ,154.77810669 ,159.60960388 ,0.06775019],
                               [0,2.81684875 ,69.76799011 ,177.7852478 ,0.00627357],
                               [176.40226746 ,38.65771484 ,249.32281494 ,110.76625061 ,0.09283278],
                               [185.45297241 ,20.38734627 ,244.29400635 ,77.18076324 ,0.08613498],
                               [58.23952866 ,238.90270996 ,147.38870239 ,300,0.04670634],
                               [1.30950928 ,179.09700012 ,68.13838196 ,283.1227417 ,0.02850085],
                               [124.38286591 ,48.94468689 ,222.79556274 ,153.64874268 ,0.22763886],
                               [130.62490845 ,80.86366272 ,265.15667725 ,209.88417053 ,0.01711313],
                               [78.07748413 ,57.27007294 ,267.72546387 ,250.21691895 ,0.01794369],
                               [184.52871704 ,15.67106247 ,273.58712769 ,98.35186768 ,0.07305629],
                               [218.02505493 ,0,290.96124268 ,106.01103973 ,0.0080685 ],
                               [24.14968491 ,1.24462509 ,99.05154419 ,60.17544174 ,0.01990201],
                               [226.55055237 ,19.23169708 ,299.05441284 ,152.05499268 ,0.01747132],
                               [5.99787903 ,7.10950279 ,79.20965576 ,89.59010315 ,0.03563789]])

    # print(np_pred_bboxes.astype(int))
    int_np_pred_bboxes=[]
    for bboxes in np_pred_bboxes:
        newbboxes = [int(b) for b in bboxes[:-1]]
        newbboxes.append(bboxes[4])
        int_np_pred_bboxes.append(newbboxes)
    print(int_np_pred_bboxes)
    res = vector_iou(np_gt_bboxes, np.array(int_np_pred_bboxes))
    print(res)

if __name__=='__main__':
    Test_vector_iou()



